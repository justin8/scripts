#!/bin/bash

BACKUPDIR=/raid/shares/backups/Linux
DATE=`date +%Y-%m-%d`
LOG=/var/log/backup-system.log

DIR=`readlink -f "${0}"`
DIR=`dirname ${DIR}`
. ${DIR}/lib/check

exec > >(tee ${LOG})

if [[ $EUID -ne 0 ]]; then
	echo "This script must be run as root" 1>&2
	exit 1
fi

if [ $# -lt 1 ] ; then
	echo "${DATE}You must specify which machine to make an image of, or multiple machines."
	exit 1
fi


echo "" > ${LOG}

for var in $@
do
	case "${var}" in
		abachi)
			echo -n "${DATE} Backing up abachi... "
			dd if=`mount|grep "on / type"|grep -o "/dev/sd[a-z]"` of=${BACKUPDIR}/abachi.img.${DATE} bs=1M 2>>${LOG}
			check $?;;
		bloodwood|birch|mahogany)
			echo -n "Backing up ${var}..."
			cp /raid/virtual-machines/${var}.qed ${BACKUPDIR}/${var}.qed.${DATE} 2>>${LOG}
			check $?;;
		*) echo "${var} is unknown; skipping."
	esac
done

exit 0
