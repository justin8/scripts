#!/bin/bash
INPUT=/raid/server-files/downloads/complete/torrents
OUTPUT=/raid/server-files/downloads/complete

function linktorrent { 
#Clean up temp files before starting
rm -rf "/tmp/$(basename $0)*"

find "$INPUT/$1" -type d > "/tmp/$(basename $0).dirs" || exit 1
sed -i "s#$INPUT/##g" "/tmp/$(basename $0).dirs" || exit 1
while read line
do
	mkdir -p "$OUTPUT/$line"
	sudo chown -R downloads. "$OUTPUT/$line" > /dev/null 2>&1
done < "/tmp/$(basename $0).dirs"

find "$INPUT/$1" -type f > "/tmp/$(basename $0).input" || exit 1
while read line
do
	curfile=$(echo "$line"|sed "s#$INPUT/##g")
	ln -P "$line" "$OUTPUT/$curfile"
	sudo chown -R downloads. "$OUTPUT/$curfile" > /dev/null 2>&1
done < "/tmp/$(basename $0).input"
}

if [ $# -lt 1 ]; then

	for torrent in $INPUT/*
	do
		bntorrent=$(echo "$torrent"|sed "s#$INPUT/##")
		if [[ ! -e "$INPUT/.link/$bntorrent" ]]; then
			echo "Linking ${bntorrent}..."
			linktorrent "$bntorrent"
			if [ $? == 0 ]; then
				touch "$INPUT/.link/$bntorrent"
			fi
		fi
	done

elif [ $# -eq 3 ]; then
	linktorrent "$2"
else
	echo "USAGE: $(basename $0) [torrent-hash] [torrent-name] [torrent-path]"
	echo "Either all parameters or none must be specified. If they are omitted, all previously-unlinked torrents will be linked"
	echo "These 3 parameters are supplied by Deluge's execute script function"
	exit 1
fi

rm -rf "/tmp/$(basename $0).dirs"
rm -rf "/tmp/$(basename $0).input"
