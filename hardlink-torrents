#!/bin/bash
INPUT=/raid/server-files/downloads/complete/torrents
OUTPUT=/raid/server-files/downloads/complete

function linktorrent { 
#Clean up temp files before starting
rm -rf "/tmp/$(basename $0)*"

find "$INPUT/$1" -type d > "/tmp/$(basename $0).dirs"
sed -i "s#$INPUT/##g" "/tmp/$(basename $0).dirs"
while read line
do
	mkdir -p "$OUTPUT/$line"
done < "/tmp/$(basename $0).dirs"

find "$INPUT/$1" -type f > "/tmp/$(basename $0).input"
while read line
do
	curfile=$(echo $line|sed "s#$INPUT/##g")
	ln -P "$line" "$OUTPUT/$curfile"
	chmod --reference="$line" "$OUTPUT/$curfile"
done < "/tmp/$(basename $0).input"
}

for torrent in $INPUT/*
do
	bntorrent=$(echo $torrent|sed "s#$INPUT/##")
	if [[ ! -e "$INPUT/.link/$bntorrent" ]]; then
		echo "Linking ${bntorrent}..."
		linktorrent "$bntorrent"
		touch "$INPUT/.link/$bntorrent"
		read
	fi
done

chown -R downloads. $OUTPUT
