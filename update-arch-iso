#!/bin/bash

BUILDDIR="/raid/server-files/build/iso"
XBMCBUILDDIR="/raid/server-files/build/xbmc-iso"
OUTPUT="/raid/shares/OSes/x86/Arch"
SCRIPTS="/raid/server-files/scripts/other"

# Initial checks
if [[ $EUID -ne 0 ]]; then
	echo "This script must be run as root" 1>&2
	exit 1
fi

if [[ $1 == "xbmc" ]]; then
	echo "Building XBMC variant ISO..."
	BUILDDIR=${XBMCBUILDDIR}
	XBMCBUILD="true"
else
	XBMCBUILD="false"
fi

echo "Preparing build environment..."
cd $BUILDDIR
rm -rf $BUILDDIR/work

if [[ $XBMCBUILD == "false" ]]; then
	mkdir -p $BUILDDIR/root-image/usr/local/bin
	rm -rf $BUILDDIR/root-image/usr/local/bin/*
	cp $SCRIPTS/*physical* $BUILDDIR/root-image/usr/local/bin
else
	mkdir -p $BUILDDIR/root-image/root/.xbmc/userdata
	cp /raid/server-files/xbmc/userdata/advancedsettings.xml $BUILDDIR/root-image/root/.xbmc/userdata/
fi

./build.sh -o $OUTPUT
rm -rf $BUILDDIR/work
chown -R downloads. $OUTPUT

if [[ $XBMCBUILD == "false" ]]; then
	echo "Updating PXE boot image on bloodwood..."
	ssh bloodwood "/root/update-arch-pxe"
fi
