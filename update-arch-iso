#!/bin/bash

BUILDDIR="/srv/repo/iso/archiso"
OUTPUT="/raid/shares/OSes/x86/Arch"
SCRIPTS="/raid/server-files/scripts/iso-scripts"
LOG="/var/log/$(basename $0).log"

# Initial checks
if [[ $EUID -ne 0 ]]; then
	echo "This script must be run as root" 1>&2
	exit 1
fi

echo "Preparing build environment..."
cd $BUILDDIR
rm -rf $BUILDDIR/work
git reset --hard
git pull

mkdir -p $BUILDDIR/root-image/usr/local/bin
rm -rf $BUILDDIR/root-image/usr/local/bin/*
cp -L $SCRIPTS/* $BUILDDIR/root-image/usr/local/bin
echo "Building ISO (this may take several minutes)..."
./build.sh -vo $OUTPUT > $LOG 2>&1
[[ $? != 0 ]] && echo "An error has occurred while creating the ISO. Please view $LOG for more details" && exit 1

rm -rf $BUILDDIR/work
chown -R downloads. $OUTPUT

#echo "Updating PXE boot image on bloodwood..."
#ssh bloodwood "/root/update-arch-pxe"
